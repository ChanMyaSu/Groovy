@page "/playlists/details"
@using Microsoft.EntityFrameworkCore
@using Groovy.Domain
@inject IDbContextFactory<Groovy.Data.GroovyContext> DbFactory
@inject NavigationManager Nav

<PageTitle>Playlist</PageTitle>

@if (playlist is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
            <h2 class="mb-0">@playlist.Name</h2>
            <div class="text-muted">@Songs.Count songs</div>
        </div>
        <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary" href="/playlists">Back</a>
            <a class="btn btn-outline-primary" href="@($"/playlists/edit?id={playlist.Id}")">Edit</a>
        </div>
    </div>

    @if (Songs.Count == 0)
    {
        <div class="p-4 border rounded-3 bg-light">
            <b>No songs in this playlist yet.</b>
        </div>
    }
    else
    {
        <div class="list-group shadow-sm">
            @foreach (var s in Songs)
            {
                <div class="list-group-item d-flex align-items-center justify-content-between">
                    <div class="me-3">
                        <div class="fw-semibold">@s.Title</div>
                        <div class="text-muted small">
                            @FormatDuration(s.DurationSec)
                            <span class="mx-1">•</span>
                            @(s.ReleaseDate?.Year.ToString() ?? "—")
                            <span class="mx-1">•</span>
                            @(string.IsNullOrWhiteSpace(s.MoodTag) ? "no vibe" : s.MoodTag)
                        </div>
                    </div>
                </div>
            }
        </div>
    }
}

@code {
    private Playlist? playlist;
    private List<Song> Songs = new();

    [SupplyParameterFromQuery] private int Id { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var db = DbFactory.CreateDbContext();

        playlist = await db.Playlist.FirstOrDefaultAsync(p => p.Id == Id);
        if (playlist == null)
        {
            Nav.NavigateTo("/playlists");
            return;
        }

        Songs = await db.PlaylistSong
            .Where(ps => ps.PlaylistId == Id)
            .Join(db.Song, ps => ps.SongId, s => s.Id, (ps, s) => s)
            .OrderBy(s => s.Title)
            .ToListAsync();
    }

    string FormatDuration(int sec)
    {
        if (sec <= 0) return "0:00";
        var m = sec / 60;
        var s = sec % 60;
        return $"{m}:{s:D2}";
    }
}

