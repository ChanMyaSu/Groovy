@page "/playlists/edit"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@using Groovy.Domain
@inject IDbContextFactory<Groovy.Data.GroovyContext> DbFactory
@inject AuthenticationStateProvider Auth
@inject NavigationManager Nav

<PageTitle>Edit Playlist</PageTitle>

@if (playlist is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <h2 class="mb-3">Edit Playlist</h2>

    @if (!string.IsNullOrWhiteSpace(Status))
    {
        <div class="alert alert-info py-2">@Status</div>
    }

    <div class="card p-3 shadow-sm" style="max-width:520px;">
        <div class="mb-3">
            <label class="form-label">Name</label>
            <input class="form-control" @bind="playlist.Name" />
        </div>

        <div class="d-flex gap-2">
            <button class="btn btn-primary" @onclick="Save">Save</button>
            <a class="btn btn-outline-secondary" href="/playlists">Cancel</a>
        </div>
    </div>
}

@code {
    private Playlist? playlist;
    private string Status = "";
    private string? UserId;

    [SupplyParameterFromQuery] private int Id { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var authState = await Auth.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user?.Identity?.IsAuthenticated != true)
        {
            Nav.NavigateTo("/Account/Login");
            return;
        }

        UserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        using var db = DbFactory.CreateDbContext();
        playlist = await db.Playlist.FirstOrDefaultAsync(p => p.Id == Id);

        if (playlist == null)
        {
            Nav.NavigateTo("/playlists");
            return;
        }

        if (playlist.AppUserId != UserId)
        {
            Nav.NavigateTo("/playlists");
            return;
        }
    }

    private async Task Save()
    {
        if (playlist == null) return;

        var name = (playlist.Name ?? "").Trim();
        if (name.Length == 0)
        {
            Status = "Name cannot be empty.";
            return;
        }
        if (name.Length > 120) name = name[..120];

        using var db = DbFactory.CreateDbContext();
        var dbPlaylist = await db.Playlist.FirstOrDefaultAsync(p => p.Id == playlist.Id);
        if (dbPlaylist == null)
        {
            Status = "Playlist not found.";
            return;
        }

        dbPlaylist.Name = name;
        dbPlaylist.DateUpdated = DateTime.UtcNow;
        dbPlaylist.UpdatedBy = UserId ?? "System";

        await db.SaveChangesAsync();
        Nav.NavigateTo($"/playlists/details?id={dbPlaylist.Id}");
    }
}
