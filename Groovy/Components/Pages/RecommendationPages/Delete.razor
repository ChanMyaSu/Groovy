@page "/recommendations/delete"
@attribute [Authorize(Roles = "Administrator, User, Artist")]
@inject IDbContextFactory<GroovyContext> DbFactory
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavigationManager

<PageTitle>Delete</PageTitle>

<h1>Delete</h1>

@if (!string.IsNullOrWhiteSpace(error))
{
    <div class="alert alert-danger">@error</div>
}
else if (recommendation is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <p>Are you sure you want to delete this recommendation?</p>

    <dl class="row">
        <dt class="col-sm-2">GeneratedAt</dt>
        <dd class="col-sm-10">@recommendation.GeneratedAt</dd>

        <dt class="col-sm-2">AlgorithmUsed</dt>
        <dd class="col-sm-10">@recommendation.AlgorithmUsed</dd>
    </dl>

    <EditForm Model="recommendation" OnValidSubmit="DeleteRecommendation">
        <button type="submit" class="btn btn-danger">Delete</button>
        <a class="btn btn-outline-secondary ms-2" href="/recommendations">Cancel</a>
    </EditForm>
}

@code {
    private Recommendation? recommendation;
    private string error = "";
    private bool isAdmin;
    private string? userId;

    [SupplyParameterFromQuery] private int Id { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var auth = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = auth.User;

        userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        isAdmin = user.IsInRole("Administrator");

        using var db = DbFactory.CreateDbContext();
        recommendation = await db.Recommendation.FirstOrDefaultAsync(r => r.Id == Id);

        if (recommendation is null)
        {
            NavigationManager.NavigateTo("notfound");
            return;
        }

        if (!isAdmin && recommendation.AppUserId != userId)
        {
            error = "You are not allowed to delete this recommendation.";
            recommendation = null;
        }
    }

    private async Task DeleteRecommendation()
    {
        if (recommendation is null) return;

        using var db = DbFactory.CreateDbContext();

        var existing = await db.Recommendation
            .Include(r => r.RecommendationSongs)
            .FirstOrDefaultAsync(r => r.Id == recommendation.Id);

        if (existing is null)
        {
            NavigationManager.NavigateTo("notfound");
            return;
        }

        if (!isAdmin && existing.AppUserId != userId)
        {
            error = "You are not allowed to delete this recommendation.";
            return;
        }

        db.RecommendationSong.RemoveRange(existing.RecommendationSongs);
        db.Recommendation.Remove(existing);

        await db.SaveChangesAsync();
        NavigationManager.NavigateTo("/recommendations");
    }
}
