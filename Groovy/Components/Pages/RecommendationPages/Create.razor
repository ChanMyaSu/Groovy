@page "/recommendations/create"
@attribute [Authorize(Roles = "Administrator, User, Artist")]
@inject IDbContextFactory<GroovyContext> DbFactory
@inject AuthenticationStateProvider AuthStateProvider
@inject IRecommendationService RecommendationService
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Find My Groove - Generate</PageTitle>

<h1>Find My Groove</h1>
<p class="text-muted">Pick up to 3 favourite artists, genres, and songs. Then generate fresh recommendations you haven't seen before.</p>

@if (!string.IsNullOrWhiteSpace(message))
{
    <div class="alert @messageClass">@message</div>
}

<div class="row">
    <div class="col-lg-4">
        <h5>Favourite Artists (max 3)</h5>
        <div style="max-height:260px; overflow:auto;" class="border rounded p-2">
            @foreach (var a in artists)
            {
                var checkedNow = selectedArtistIds.Contains(a.Id);
                var disableNow = !checkedNow && selectedArtistIds.Count >= 3;
                <div class="form-check">
                    <input class="form-check-input" type="checkbox"
                           checked="@checkedNow" disabled="@disableNow"
                           @onchange="(e) => Toggle(selectedArtistIds, a.Id, (bool)e.Value!)" />
                    <label class="form-check-label">@a.Name</label>
                </div>
            }
        </div>
    </div>

    <div class="col-lg-4">
        <h5>Favourite Genres (max 3)</h5>
        <div style="max-height:260px; overflow:auto;" class="border rounded p-2">
            @foreach (var g in genres)
            {
                var checkedNow = selectedGenreIds.Contains(g.Id);
                var disableNow = !checkedNow && selectedGenreIds.Count >= 3;
                <div class="form-check">
                    <input class="form-check-input" type="checkbox"
                           checked="@checkedNow" disabled="@disableNow"
                           @onchange="(e) => Toggle(selectedGenreIds, g.Id, (bool)e.Value!)" />
                    <label class="form-check-label">@g.Name</label>
                </div>
            }
        </div>
    </div>

    <div class="col-lg-4">
        <h5>Favourite Songs (max 3)</h5>
        <div style="max-height:260px; overflow:auto;" class="border rounded p-2">
            @foreach (var s in songs)
            {
                var checkedNow = selectedSongIds.Contains(s.Id);
                var disableNow = !checkedNow && selectedSongIds.Count >= 3;
                <div class="form-check">
                    <input class="form-check-input" type="checkbox"
                           checked="@checkedNow" disabled="@disableNow"
                           @onchange="(e) => Toggle(selectedSongIds, s.Id, (bool)e.Value!)" />
                    <label class="form-check-label">@s.Title</label>
                </div>
            }
        </div>
    </div>
</div>

<div class="mt-4 d-flex gap-2">
    <button class="btn btn-primary" @onclick="Generate" disabled="@isBusy">Generate</button>
    <a class="btn btn-outline-secondary" href="/recommendations">Back</a>
</div>

@code {
    private List<Artist> artists = new();
    private List<Genre> genres = new();
    private List<Song> songs = new();

    private List<int> selectedArtistIds = new();
    private List<int> selectedGenreIds = new();
    private List<int> selectedSongIds = new();

    private string message = "";
    private string messageClass = "alert-info";
    private bool isBusy;

    private string? userId;

    protected override async Task OnInitializedAsync()
    {
        using var db = DbFactory.CreateDbContext();

        artists = await db.Artist.OrderBy(a => a.Name).ToListAsync();
        genres = await db.Genre.OrderBy(g => g.Name).ToListAsync();
        songs = await db.Song.OrderBy(s => s.Title).ToListAsync();

        var auth = await AuthStateProvider.GetAuthenticationStateAsync();
        userId = auth.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    }

    private void Toggle(List<int> list, int id, bool isChecked)
    {
        if (isChecked)
        {
            if (!list.Contains(id) && list.Count < 3) list.Add(id);
        }
        else
        {
            list.Remove(id);
        }
    }

    private async Task Generate()
    {
        message = "";
        messageClass = "alert-info";

        if (string.IsNullOrWhiteSpace(userId))
        {
            message = "You are not logged in.";
            messageClass = "alert-danger";
            return;
        }

        if (selectedArtistIds.Count == 0 && selectedGenreIds.Count == 0 && selectedSongIds.Count == 0)
        {
            message = "Pick at least 1 artist, genre, or song.";
            messageClass = "alert-warning";
            return;
        }

        isBusy = true;
        try
        {
            var rec = await RecommendationService.GenerateFindMyGrooveAsync(
                userId,
                selectedArtistIds,
                selectedGenreIds,
                selectedSongIds,
                4);

            NavigationManager.NavigateTo($"/recommendations/details?id={rec.Id}");
        }
        catch
        {
            message = "Something went wrong while generating. Try again.";
            messageClass = "alert-danger";
        }
        finally
        {
            isBusy = false;
        }
    }
}
